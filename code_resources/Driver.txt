NTSTATUS DriverEntry(PDRIVER_OBJECT DriverObject, PUNICODE_STRING puString) {

	UNREFERENCED_PARAMETER(puString);

	DbgPrintEx(0, 0, "85693.1267 Driver Loading...\n");

	NTSTATUS status = STATUS_SUCCESS;
	UNICODE_STRING deviceName = RTL_CONSTANT_STRING(L"\\Device\\Protector");
	UNICODE_STRING symLinkName = RTL_CONSTANT_STRING(L"\\??\\Protector");
	PDEVICE_OBJECT DeviceObject = NULL;

	PsSetLoadImageNotifyRoutine((PLOAD_IMAGE_NOTIFY_ROUTINE)ImageLoadCallback);

	status = IoCreateDevice(DriverObject, 0, &deviceName, FILE_DEVICE_UNKNOWN, 0, FALSE, &DeviceObject);

	if (!NT_SUCCESS(status)) {
		DbgPrintEx(0, 0, "failed to create device object (status=%08X)\n", status);
		return status;
	}

	status = IoCreateSymbolicLink(&symLinkName, &deviceName);

	if (!NT_SUCCESS(status)) {
		DbgPrintEx(0, 0, "failed to create symbolic link (status=%08X)", status);
		IoDeleteDevice(DeviceObject);
		return status;
	}

	OB_OPERATION_REGISTRATION operations[] = {
		{
		PsProcessType,
		OB_OPERATION_HANDLE_CREATE | OB_OPERATION_HANDLE_DUPLICATE,
		PreOpenProcessOperation, NULL
		}
	};

	OB_CALLBACK_REGISTRATION reg = {
		OB_FLT_REGISTRATION_VERSION,
		1,
		RTL_CONSTANT_STRING(L"85693.1267"),
		NULL,
		operations
	};